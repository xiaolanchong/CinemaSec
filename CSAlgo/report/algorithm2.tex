%%%%%%%%%%%%%%%%%%%%%%
\section{Алгоритм 2}
\label{sec:algorithm2}
%%%%%%%%%%%%%%%%%%%%%%
%
Второй алгоритм, также как и первый, анализирует область кресла очерченную оператором (область анализа) по двум параметрам -- наличию или отсутствию объекта в кресле и наличию или отсутствию движения в кресле. Кресло считается занятым человеком, если значительное время его изображение отличалось от изображения пустого кресла и внутри области анализа было зафиксировано существенное движение. Принципиальное отличие второго алгоритма состоит в способе анализа динамики. В первом алгоритме мы искали интевалы движения, подсчитывали их длительность и количество. Однако в тёмных залах из-за недостаточного накопления кадров часто возникали ложные, шумовые динамические интервалы. Во втором алгоритме мы отказались от фиксированного времени накопления кадров. Кадры копятся до тех пор пока отношение сигнал/шум не достигнет заданной величины, см. раздел~\ref{sec:augment-signal-noise}. Теперь мы не можем выставить \textit{фиксированный} порог на межкадровые изменения, т.к. он зависит от текущей засветки зала. Поэтому от анализа динамических интервалов мы перешли к анализу изменения формы (позы) объекта (зрителя) находящегося в кресле в течении киносеанса.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Построение статических интервалов}
\label{sec:stat-interval}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
В процессе наблюдения за креслом создаётся и пополняется список т.н. статических интервалов. \textit{Статическим интервалом} мы называет временной промежуток в течении которого изображение кресла отличалось от соответствующего шаблона пустого кресла. Как только отличие между изображением кресла и шаблоном (например (\ref{eq:robust-ncc})) превысило порог $\mbox{statThr}$, создаётся новый интервал, который добавляется в конец списка интервалов данного кресла. Для придания устойчивости используется гистерезисная схема. Если порог превышен, начинается ``зарядка аккумулятора'' -- временной переменной $\mbox{charge}$ ассоциированной с креслом
%
\begin{equation}
\label{eq:charging}
{\rm charge}_t = {\rm max} - \left( {{\rm max} - {\rm charge}_{t - \Delta t} } \right)
                 \exp \left( { - \frac{{\Delta t}}{\tau }} \right),
\end{equation}
%
\noindent где $\mbox{max}$ есть максимальное значение, равное $2$, для функции расстояния (\ref{eq:ncc}) и, приблизительно, для функции (\ref{eq:robust-ncc}), ${\Delta}t$ есть время прошедшее между текущим и предыдущим кадром, ${\tau}$ есть параметр временного сглаживания. Обычно значение порога $\mbox{statThr}$ существенно меньше чем $\mbox{max}$.

Интервал помечается как \textit{занятый} (occupied), если отличие между изображением кресла и шаблоном превышает порог $\mbox{statThr}$. Интервал помечается как \textit{устойчиво занятый} (hard occupied), если $(\mbox{charge}>\mbox{statThr})$. Как только отличие падает ниже порога ``аккумулятор'' начинает разряжаться 
%
\begin{equation}
\label{eq:discharging}
{\rm charge}_t = {\rm charge}_{t - \Delta t} \exp \left( {-\frac{{\Delta t}}{\tau }} \right).
\end{equation}
%
\noindent Однако интервал заканчивается только когда заряд ``аккумулятора'' упадёт ниже порога $(\mbox{charge}<\mbox{statThr})$. Такая гистерезисная схема позволяет не прерывать интервал, если мера отличия от пустого кресла падает ниже порога на короткий промежуток времени. Когда интервал окончательно завершается, мы сравниваем его продолжительность с заданной минимальной продолжительностью. Короткий интервал должен быть удалён из списка.

Порог $\mbox{statThr}$ устанавливается вручную. Чтобы облегчить процесс выбора оптимального порога нами было проанализировано значительное количество видеороликов размеченных вручную.  Разметка состояла в присваивании каждому креслу типа объекта (пустое кресло, вещь или человек) и временных интервалов, в течении которых этот тип не менялся. Более подробно процедура разметки описана в документации к программе \textit{CSClient}. Результатом прогона размеченных видеороликов явилась гистограмма распределения меры отличия изображения кресла от шаблона пустого кресла для каждого типа в отдельности, см. рисунок~\ref{fig:stat-thr}. Из приведённых распределений видно, что пустые кресла достаточно хорошо отделяются от кресел занятых людьми. Однако распределение соответствующее одежде, оставленной на кресле, сильно пересекается как с распределением пустых кресел, так и с распределением людей. Поэтому требуется анализ динамики, чем мы и займёмся в следующем разделе.

\myfigure[0.7]{figures/statthr.eps}{Распределения меры отличия изображения кресла от шаблона пустого кресла. Красным цветом показано распределение пустых кресел (из-за шумов мера отличия не равна нулю). Зелёным цветом показано распределение одежды. Синим цветом показано распределение людей.}{stat-thr}

Процедура сравнения текущего изображения кресла с шаблоном пустого кресла имеет ещё одну техническую особенность, которую стоит упомянуть. Перед началом работы системы мы загружаем файлы содержащие положение очерченной области анализа для каждого кресла, статический фон (см. раздел~\ref{sec:correlation}), который будет использоваться в качестве первого шаблона и, возможно, дополнительные шаблоны пустого кресла. К сожалению, в процессе работы камеры могут слегка менять направление обзора, что связано с вибрациями, проседанием конструкции зала и т.п. Поэтому очерченная область анализа может слегка смещаться относительно своего правильного положения. Чтобы компенсировать этот эффект, мы коррелирует изображение кресла с множеством сдвинутых шаблонов. Сдвиг обычно составляет $1{\div}2$ пиксела по каждой координате. В результате мы должны произвести $9{\div}25$ сравнений со сдвинутым шаблоном. Мерой отличия считается минимальное значение полученное с каким-либо сдвигом. 
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Анализ динамики}
\label{sec:dynamics}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Пусть изображение в точке ${\bf r}$ принадлежащей креслу в момент времени $t$ задано функцией яркости $I({\bf r},t)$. Чтобы сделать алгоритм слабо-чувствительным к вариациям засветки, что крайне важно в условиях кинотеатра, мы преобразуем изображения согласно одной из следующих формул
%
\begin{equation}
\label{eq:mean-norm-chair}
I^* ({\bf r},t)
= \frac{{I({\bf r},t)}}{{\left( {\frac{1}{N}\sum \limits _{\bf r} {I({\bf r},t)} } \right)}}
= \frac{{I({\bf r},t)}}{{m_{\bf r}(t)}}
\end{equation}
%
\noindent или
%
\begin{equation}
\label{eq:dev-norm-chair}
I^* ({\bf r},t)
= \frac{{I({\bf r},t) - \left( {\frac{1}{N}\sum \limits _{\bf r} {I({\bf r},t)} } \right)}}{{\sqrt {\left( {\frac{1}{N}\sum \limits _{\bf r} {I^2 ({\bf r},t)} } \right) -
\left( {\frac{1}{N}\sum \limits _{\bf r} {I({\bf r},t)} } \right)^2 } }}
= \frac{{I({\bf r},t) - m_{\bf r} (t)}}{{\sigma _{\bf r} (t)}},
\end{equation}
%
\noindent где $N$ это число точек кресла, $m_{\bf r}(t)$ это среднее по креслу значение интенсивности в момент $t$, а ${\sigma}_{\bf r}(t)$ это девиация интенсивности в кресле в момент $t$. Важно подчеркнуть, что усреднение в вышеприведённых формулах производится в пределах зоны анализа \textit{одного кресла}. Нижний индекс ${}_{\bf{r}}$ напоминает, что усреднение пространственное, а не временное. Легко показать, что в первом случае мы освобождаемся от влияния мультипликативного фактора, т.е. $I$ и $aI$ дают одно и то же значение $I^*$, где $a$ произвольный множитель. Во втором случае результирующее изображение $I^*$ нечувствительно к произвольному линейному преобразованию исходного изображения, т.е. $I$ и $aI{\!}+{\!}b$ эквивалентны. Для анализа динамики вполне достаточно нормализовать изображение кресла по формуле (\ref{eq:mean-norm-chair}).

Поскольку из-за шумов и слабой освещенности мы вынуждены интегрировать изображение идущее от камеры с большим временем интегрирования (раздел~\ref{sec:frame_updating}), движение объекта становиться практически незаметным, особенно в тёмных залах. Причём время интегрирования зависит от текущей засветки. Поэтому трудно подобрать оптимальный порог изменения изображения, чтобы надёжно зафиксировать движение.

Во второй версии алгоритма мы пошли другим путём. Теперь мы не пытаемся зафиксировать движение между последовательными кадрами, а отслеживаем изменение геометрии (позы) объекта (зрителя) занимающего кресло. Динамический анализ производится только для кресел, в которых зафиксирован объект, т.е. во время действия статического интервала, см. раздел~\ref{sec:stat-interval}. \textit{Динамическая характеристика} объекта, находящегося в кресле, есть сумма средних по времени квадратов отклонений от средних всех точек кресла
%
\begin{eqnarray}
d &=& \frac{1}{N}\sum \limits _{\bf r} {\left[
{\frac{1}{T}\sum \limits _{t = 1}^T {\left( {I^* ({\bf r},t) -
\left( {\frac{1}{T}\sum \limits _{t=1}^T {I^* ({\bf r},t)} } \right)} \right)^2 } } \right]} \nonumber \\
&=& \frac{1}{N}\sum \limits _{\bf r} {\left[ {\left( {\frac{1}{T}\sum \limits _{t = 1}^T {\left( {I^*({\bf r},t)} \right)^2 } } \right) - \left( {\frac{1}{T}\sum \limits _{t=1}^T {I^* ({\bf r},t)} } \right)^2 } \right]}, 
\end{eqnarray}
%
\noindent где переменная $t$ пробегает от момента начала наблюдения ($t=1$) до текущего момента ($t=T$), переменная ${\bf{r}}$ пробегает по всем точкам кресла, а изображение $I^*$ берётся нормированным по формуле (\ref{eq:mean-norm-chair}) или (\ref{eq:dev-norm-chair}). Динамическая характеристика описывает конкретный статический интервал. Она обнуляется с началом нового статического интервала.

Логика принятия решения такова. Если кресло занято объектом и этот объект накопил в течении статического интервала достаточную меру изменений, т.е. динамическая характеристика превысила заданный порог \texttt{dynaThr}, то мы считаем объект зрителем, иначе вещью лежащей на кресле.

К сожалению, динамическая характеристика не столь дискриминативна как хотелось бы. На рисунке~\ref{fig:dyna-thr} показаны гистограммы динамической характеристики, полученные прогоном по многим видеороликам размеченным вручную. Оказалось, что многие вещи, оставленные на кресле, имееют ненулевую динамику. В результате гистограммы соответствующие людям и вещам значительно пересекаются. Это происходит, во-первых, из-за остаточных шумов. Во-вторых, при яркой вспышке на экране вещи лежащие на передних креслах пересвечиваются (исчезает текстура, складки одежды и т.п.). Как только освещение падает, проявляется структура одежды. Алгоритм воспринимает это как движение внутри кресла. В-третьих, люди периодически шевелят одежду оставленную на соседнем кресле. Есть ещё небольшой вклад в динамику помех камеры, мерцания боковой засветки и т.п.

\myfigure[0.7]{figures/dynathr.eps}{Распределения меры динамической характеристики одежды оставленной на кресле (красный цвет) и людей сидящих в кресле (зеленый цвет). Логарифмический масштаб вдоль оси $Y$.}{dyna-thr}

Казалось бы проблему можно решить повышая порог на динамическую характеристику пока распределения (рисунок~\ref{fig:dyna-thr}) не будут хорошо разделены. Оказалось, однако, что некоторые люди настолько мало двигаются в течении сеанса, что не удаётся накопить достаточную меру изменений изображения объекта в кресле. Поэтому механическое увеличение порога не достигает желаемой цели. Чтобы снять остроту проблемы мы поступает следующим образом. Если объект сильно отличается от пустого кресла, т.е. статическая корреляция (см. раздел~\ref{sec:correlation}) превышает заданный ``сильный'' порог \texttt{strongStatThr}, то мы позволяем такому объекту стать человеком имея динамическую характеристику превышающую лишь заданный ``слабый'' порог \texttt{weakDynaThr}. Соотношения между порогами таковы
%
\[
\mbox{statThr} < \mbox{strongStatThr}, \hspace{10 mm} \mbox{weakDynaThr} < \mbox{dynaThr}.
\]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Логика принятия решений}
\label{sec:decision-logic}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%