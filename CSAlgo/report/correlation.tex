%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Определение пустых кресел через корреляцию}
\label{sec:correlation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Важной частью первой и второй реализаций алгоритма является процедура разделяющая пустые кресла и кресла занятые человеком или вещами. Разделение происходит путём сравнения текущего изображения кресла с изображением (шаблоном), полученным для пустого зала в режиме настройки программы. Процесс получения и использования шаблонов выглядит следующим образом:
%
\begin{enumerate}
\itemsep = -\parsep
\item После монтажа всех камер, для каждого зала кинотеатра содаётся т.н. \textit{статический фон}. Для этого в полной темноте включается кинопроектор \textbf{без} плёнки, примерно на одну минуту. В этот момент запускается программа \textit{CSClient}, которая накапливает, в иечении всего интервала, изображения для каждой камеры данного зала. Полученное длительным накоплением изображение практически свободно от шумов. Кроме того, все кресла в зале оказываются освещеными строго от экрана (другие источники выключены), что позволяет имитировать условия реального киносеанса. В результате для каждой камеры мы имеем изображения кресел, которые могут быть использованы в качестве шаблонов.  
\item После того, как статические фоновые изображения получены для всех камер, в той-же программе \textit{CSClient} человек-оператор вручную очерчивает замкнутый контур кресла, см. pисунок~\ref{fig:outline-example}. Внутреннюю область контура в дальнейшем будем называть \textit{областью анализа}, поскольку её точки используются в процессе распознавания. Точки изображения, лежащие снаружи контуров кресел в первой и во второй версиях алгоритма \textbf{не} используются для обнаружения человека. Обычно область анализа составляет примерно {\myfrac 2/3} верхней части спинки кресла.
%
\myfigure[0.8]{figures/chairs.eps}{Пример обрисовки области кресла. Показана часть изображения получаемого с камеры.}{outline-example}
%
\item Накопленный статический фон каждой камеры сохраняется в виде 32-битного \texttt{bitmap} изображения, пикселы которого реально являются значениями типа \texttt{float}. При запуске процесса распознавания, статический фон и контура кресел, введённые оператором, загружаются для каждой камеры в отдельности и используются в работе алгоритма.    
\item В процессе работы алгоритма область занятая креслом на текущем изображении сравнивается с соответсвующей областью на статитческом фоне. Если отличие велико, мы говорим что кресло занято человеком или вещами. В противном случае, мы считаем что кресло свободно. Процедуру сравнения мы называем (не очень удачно) \textit{статической корреляцией}. Фактически мы вычисляем расстояние между текущим изображением креста и \textit{шаблоном}, который соответствует области кресла на статическом фоне. Вычисленная мера отличия сравнивается с заданным порогом. Различные варианты вычисления расстояний между парой изображений обсуждаются в следующих разделах. 
\end{enumerate}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Нормализованная кросс-корреляция}
\label{sec:ncc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Распространённым способом сравнения двух изображения является следующая функция расстояния
%
\begin{equation}
\label{eq:ncc}
\rho (I_1 ,I_2 ) = \frac{1}{N} \sum \limits _{i=1}^{N} {\left(
  {\frac{{I_{1,i} - m_1 }}{{\sigma _1 }} -
   \frac{{I_{2,i} - m_2 }}{{\sigma _2 }}} \right)^2}, 
\end{equation}
%
\[
m_k  = \left\langle {I_k} \right\rangle , \hspace{5 mm} \sigma _k = \sqrt {\left\langle {I_k^2} \right\rangle  - \left\langle {I_k} \right\rangle ^2} , \hspace{5 mm} k=1,2 
\]
%
\noindent где $m_k$ есть средняя интенсивность $k$-го изображения в пределах кресла, ${\sigma}_k$ есть девиация интенсивности $k$-го изображения. Суммирование идёт по всем точкам области кресла, $N$ есть число точек кресла. Легко показать, что приведённая выше функция расстояния связана с т.н. нормализованной кросс-корреляцией (normalized cross-correlation)
%
\[
\rho (I_1 ,I_2 ) = 2 - 2\sum \limits _i {\left( {\frac{{I_{1,i}  - m_1 }}{{\sigma _1 }}} \right)\left( {\frac{{I_{2,i}  - m_2 }}{{\sigma _2 }}} \right)}  = 2\left( {1 - \frac{{\left \langle {I_1 I_2 } \right \rangle  - m_1 m_2 }}{{\sigma _1 \sigma _2 }}} \right).
\]
%
\noindent Нормализованная кросс-корреляция считается оптимальной оценкой среди других оценок использующих первый и второй моменты распределения интенсивности (Rosenfeld \& Kak). Кроме того, её можно посчитать за один проход по пикселам изображения. Важным моментом является использование нормализованных изображений. В данном случае нормализация означает следующее преобразование
\[ I_i^* = \frac{{I_i - m}}{\sigma}, \]
которое, как легко видеть, делает результирующее изображение $I^*$ нечувствительным к произвольному линейному преобразованию исходного изображения, т.е. $I$ и $aI{\!}+{\!}b$ эквивалентны. Последнее обостоятельство принципиально важно в условиях постоянно изменяющейся засветки кинозала.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Робастная мера отличия}
\label{sec:robust-ncc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Недостатком функции (\ref{eq:ncc}) является высокая чувствительность к небольшим по площади, но высококонтрастным различиям между двумя изображениями. Например, если на кресле лежит яркая белая одежда занимающая небольшую часть области анализа, то расстояние вычисленное по формуле (\ref{eq:ncc}) может превысить порог при том, что изображение кресла текущего кадра и шаблон близки в большинстве других точек. Главная проблема заключается в вычислении величины девиации ${\sigma}$, которая весьма чувтствительна к выбросам (outliers) данных. Более устойчивая (робастная) оценка ${\sigma}$ основана на вычислении среднего, а не среднеквадратического отклонения
%
\[ \sigma  = \left\langle {\left| {I - m} \right|} \right\rangle, \]
%
\noindent где, как и прежде, $m$ есть средняя интенсивность изображения. Сама же разность изображений также вычисляется ``робастным'' образом
%
\begin{equation}
\label{eq:robust-ncc}
\rho _r (I_1,I_2) = \frac{1}{N} \sum \limits _{i=1}^{N} {\left|
  {\frac{{I_{1,i} - m_1 }}{{\sigma _1 }} -
   \frac{{I_{2,i} - m_2 }}{{\sigma _2 }}} \right|}.
\end{equation}
%
\noindent Мера различия (\ref{eq:robust-ncc}) менее чувствительна к малым по площади отличиям пары изображений, но быстро возрастает как только отличия становятся массовыми. Её недостатком является вычислительная неэффективность. Приходится делать три прохода по точкам изображения -- сначала вычисляются средние, затем девиации и только потом расстояние. Тем не менее, мы используем расстояние (\ref{eq:robust-ncc}) в качестве рабочего варианта.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Другие функции расстояния}
\label{sec:other-distances}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Кроме упомянутых выше, мы рассмотрели ещё два варианта функции расстояния. Первый вариант основан на нормализации значений интенсивности в точках кресла средней интенсивностью внутри кресла (mean normalization)
%
\begin{equation}
\label{eq:mean-norm}
\rho _m (I_1,I_2) = \frac{1}{N} \sum \limits _{i=1}^{N} {\left|
\frac{I_{1,i}}{m_1} - \frac{I_{2,i}}{m_2}
\right|^q } , \hspace{5 mm} q = \{1,2\} , 
\end{equation}
%
\noindent где $m_k$ есть средняя интенсивность $k$-го изображения в пределах кресла. Суммирование идёт по всем точкам области кресла, $N$ есть число точек кресла. Легко видеть, что расстояние (\ref{eq:mean-norm}) нечувствительно к произвольному линейному масштабированию исходного изображения, т.е. $I$ и $aI$ эквивалентны. Последнее означает нечувствительность к изменению засветки в кинозале во время сеанса. Эксперименты не выявили явного преимущества расстояния (\ref{eq:mean-norm}) по сравнению с расстоянием (\ref{eq:robust-ncc}), хотя первое может быть подсчитано эффективнее, всего за два прохода по изображению. По-видимому, рассматриваемая функция расстояния работает хуже на слабоосвещенных креслах, когда $m_1,m_2 < 20{\div}30$ единиц дискретизации интенсивности. В дальнейшем, имеет смысл вернуться к вопросу о применимости (\ref{eq:mean-norm}) в качестве рабочего варианта.

Ещё одна функция расстония основана на идее построения меры сходства через отношение гистограмм (Swain \& Ballard). С учётом того, что интенсивность изменяется в пределах $[0{\ldots}255]$ нелинейная функция расстояния определяется следующим образом
%
\begin{equation}
\label{eq:nonlinear-dist}
\rho _n (I_1,I_2) = \frac{1}{N} \sum \limits _{i=1}^{N} {\left(
{\frac{{\min \left( {I_{1,i},I_{2,i}} \right)}}
      {{\max \left( {I_{1,i},I_{2,i}} \right)}} +
 \frac{{255 - \max \left( {I_{1,i},I_{2,i}} \right)}}
      {{255 - \min \left( {I_{1,i},I_{2,i}} \right)}}} \right)}.
\end{equation}
%
\noindent Видно что (\ref{eq:nonlinear-dist}) достигает максимума, равного $2$, когда оба изображения совпадают. Нижний предел, видимо, равен $1$, когда во всех точках одно из изображений достигает $0$ или $255$. Возникающая в крайних случаях неопределённость типа $0/0$ разрешается следующим образом $0/0=1$. Эксперименты с упрощённой версией (\ref{eq:nonlinear-dist}), отсутствовал второй член под знаком суммы, показали нечувствительность к малым по площади отличиям пары изображений и достаточно сильную реакцию на массовые отличия. На наш вгляд, целесообразно исследовать вопрос о практической применимости расстояния (\ref{eq:nonlinear-dist}) более детально.
%
%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Маскирование}
\label{sec:masking}
%%%%%%%%%%%%%%%%%%%%%%%%%
%
Типичное изображение спинки кресла представляет собой область несколько отличающуюся по форме от прямоугольника. Вычисление расстояния между двумя изображениями непрямоугольной формы неэффективно из-за необходимости проверки попадания текущей точки в область кресла. Лучшее решение состоит в создании прямоугольной маски накрывающей область кресла. Те точки маски, которые попадают в область кресла, получают вес равный $1$, остальные вес равный $0$. Маска расчитывается до начала процесса видеонаблюдения, т.е. offline.

Ещё одно преимущество маски состоит в возможности по разному ``взвешивать'' точки изображения, в частности, приграничные точки области кресла. \textit{Приграничными} считаются точки лежащие внутри кресла в полосе шириной $5{\div}10$\% от характерного размера кресла. Во-первых, эти точки имеют нестабильную засветку -- яркая вспышка на экране приводит к появлению боковой засветки идущей от стен и потолка, а не от экрана. Этому эффекту в большей степени подвержены именно приграничные точки, т.к. они лежат на плоскостях непараллельных экрану (спинку кресла нельзя считать плоской даже приближенно). Во-вторых, люди сидящие в соседних креслах иногда могут рукой или корпусом занять часть области данного кресла, что проявляется опять-таки на приграничных точках. Поэтому для приграничных точек области кресла мы вводим вес между $0$ и $1$. Чем ближе к краю, тем меньше вес.

Обозначим вес в $i$-й точке через $w_i$. Удобно работать с нормированными весами
%
\[ \sum \limits _{i=1}^{N} {w_i} = 1, \hspace{5 mm} w_i \geqslant 0 . \]
%
\noindent Тогда во всех формулах раздела~\ref{sec:correlation} нужно скорректировать процедуру суммирования, а именно
%
\begin{eqnarray*}
\frac{1}{N} \sum \limits _{i=1}^N {x_i}   & \to & \sum \limits _{i=1}^N {w_i x_i} ,   \\
\frac{1}{N} \sum \limits _{i=1}^N {x_i^2} & \to & \sum \limits _{i=1}^N {w_i x_i^2} , \\
\frac{1}{N} \sum \limits _{i=1}^N {\left|{x_i}\right|^q} & \to &
            \sum \limits _{i=1}^N {w_i \left|{x_i}\right|^q} ,
\end{eqnarray*}
%
\noindent где $x_i$ это какая-либо величина заданная в $i$-й точке (интенсивность, разность интенсивностей и т.п.).
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Множество шаблонов}
\label{sec:multi-template}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Было замечено, что даже незанятое кресло во время сеанса может сильно изменять свой внешний вид. Это происходит из-за изменения освещенности (в результате вспышек проектора) и того, что кресло имеет не плоскую форму. Поэтому простая корреляция изображения данного кресла и изображения кресла полученного при равномерном освещении в пустом зале не дает приемлемых результатов. Для решения этой проблемы мы применили следующий прием. Для каждого кресла подготавливается несколько различных изображений пустого кресла (шаблонов) с разной освещенностью. В процессе работы, текущее изображение данного кресла сравнивается со всеми шаблонами, из которых выбирается наиболее близкий. И только тогда принимается решение о том, пусто ли данное кресло или нет. Технологически процесс подготовки набора шаблонов выглядит следующим образом.
%
\begin{enumerate}
\itemsep = -\parsep
\item Во время тестовых сеансов записывается видео для каждого кресла, с использованием разметки пустого зала;
\item С помощью кластеризации выбрасываются лишние кадры из видео;
\item Объединяются все видео последовательности за все сеансы для данного кресла и снова выбрасываются лишние кадры с помощью кластеризации;
\item После первых трех пунктов для каждого кресла получается небольшая последовательность кадров (порядка $50{\div}100$ кадров), из которых оператор вручную удаляет кадры с изображением людей и вещей, оставляя $10{\div}20$ наиболее репрезентативных изображений пустого кресла; 
\item По результатам ручной обработки всех кресел данного зала формируется файл с образцами всех пустых кресел, который и используется в работе.
\end{enumerate}
%
\myfigure[0.8]{figures/chair-templates.eps}{Пример серии шаблонов одного кресла, полученных при разных засветках кинозала. Видно, что при падении освещенности проявляются недостатки камеры в виде вертикальных полос.}{chair-templates}
%
Самый сложный из этих пунктов - четвертый, так как он выполняется не автоматически, а с участием оператора. Данный подход приводит к улучшению работы алгоритма, особенно для очень темных залов. Пример серии шаблонов показан на рисунке~\ref{fig:chair-templates}.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Краткий обзор вспомогательных программных средств}
\label{sec:template-utils}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
Процедура построения серии шаблонов для каждого кресла базируется на нескольких утилитах, библиотеках и приложениях, специально написанных для получения тестового видео о обучения. \\

\noindent \texttt{CSOnlineWriter} \\
При запуске библиотека алгоритма (\texttt{CSAlgo.dll}) ищет поблизости файл \texttt{testvideo.ini}. Если в инициализационном файле указана дата и время соответствующие текущим значениям, то загружается библиотека \texttt{CSOnlineWriter.dll}, которая в процессе работы алгоритма записывает тестовое видео. Библиотека работает в двух режимах, задаваемых в файле \texttt{testvideo.ini}. \texttt{Scenario0} предполагает запись сырого видео как есть. \texttt{Scenario1} предполагает запись интегрированного видео (раздел~\ref{sec:frame_updating}), для последующего отбора шаблонов пустых кресел. \\

\noindent \texttt{CSVideoToChairs} \\
Разрезает видео на ролики для каждого стула. Требует файла с разметкой  кресел. \\

\noindent \texttt{CSMergeChairs} \\
Объединяет все видео для отдельного стула в один видео файл. Также, для обработанных пользователем файлов, генерирует xml файл с обработанными стульями всего зала, который можно подавать в алгоритм. \\

\noindent \texttt{CSSeqRefiner} \\
GUI приложение, позволяющее пользователю выбрать вручную требуемые кадры из видеопоследовательности. \\

\noindent \texttt{CSVideoClust} \\
Консольная утилита, которая прореживает видепоследовательность, отбирая наиболее репрезентативные кадры. \\

Все утилиты ищут видео в подкаталогах с названием camNN где NN - номер камеры. Например, cam01, cam21. Номер камеры всегда задаётся двумя цифрами. Имена файлов формируются следующим образом.

\begin{enumerate}
\itemsep = -\parsep
\item \verb'clusterized_cam01_chair145.avd'. Это имя означает, что в данной видеопоследовательности, заданной в AVD-формате, выброшены лишние кадры с помощью программы \texttt{CSVideoClust}. Соответственно камера 1, стул 145.
\item \verb'merged_cam01_chair145.avd'. Это имя означает, что файл может содержать последовательности полученные за несколько сеансов, объединенные с помощью утилиты \texttt{CSMergeChairs}.
\item \verb'refined_cam01_chair145.avd'. Это означает, что файл обработан пользователем с помощью программы \texttt{CSSeqRefiner} и в нём содержатся только нужные нам изображения.
\end{enumerate}








