# САПР визуальных моделей зрительных залов кинотеатров

##	Назначение и цели создания системы

###	Назначение системы

Система визуальных моделей зрительных залов (СВМЗ) предназначена для проектирования модели существующего зрительного зала и последующей ее визуализации по текущей информации от устройств видеонаблюдения (телекамер) и является частью системы контроля зрительных залов (СКЗ).

###	Цели создания системы

Цель создания системы – получение изображения модели зрительного зала и возможность ее показа пользователю с помощью текущей информации с камер видеонаблюдения, повышая тем самым качество наблюдения и контроля ситуации в зрительном зале.

#	Характеристики объектов автоматизации

Зрительный зал представляет собой закрытое помещение определенной формы с расположенными в нем рядами кресел, проходами между и вдоль рядов.
В верхней части зала в определенных местах находятся неподвижные камеры видеонаблюдения, область видимости которых охватывают определенные (возможно пересекающиеся) участки зала.
Процесс моделирования представляет собой подбор соответствия между набором исходных изображений с камер и конечной моделью.

#	Требования к системе

##	Требование к структуре и функционированию системы

###	Требование к созданию визуальной модели:

1)	Выбрать уже существующую или похожую модель кинозала или создать ее автоматически на основе введенных параметров.
2)	Выбрать количество и расположение камер в зале.
3)	Сообщить программе источник изображения с выбранных камер: текущее видеоизображение с камеры, видеофайл с диска, файл изображения с диска. 
4)	Выбрать текущую камеру, с изображением которой будет работать пользователь. В любой момент времени существует только одна текущая камера.
5)	Редактирование опорные точки модели и входных изображений (добавление, удаление, перемещение). Опорная точка – произвольная точка, определяемая характеристиками модели (например, угол спинки кресла), необходимая для получения преобразования с исходных изображений. При этом пользователь редактирует опорные точки на модели и на изображении камеры.
6)	Доступные действия с точками:
  - добавление в выбранное место;
  - выделение выбранных точек;
  - перемещение выделенных точек;
  - удаление выделенных точек;
  - выравнивание по горизонтали или вертикали.
7)	Сохранять и загружать полученную модель.

###	Требования к входному изображению

Входное изображение представляет собой двухмерное растровое изображение произвольных размеров (если параметры не поддерживаются, следует сообщить пользователю об этом) следующих форматов:
1)	Видеоизображение с камеры ¬– изображение формата YUY2 или Y8.
2)	Видеофайл ¬– набор изображений формата RGB24 или RGB32 по 8 бит на канал. В последнем случае альфа-канал не используется.
3)	Файл изображения ¬– изображение формата RGB24 по 8 бит на канал.
При необходимости в случае изображений больших линейных размеров программа должна выполнять их масштабирование.

###	Требование к выводу изображения

Программа должна использовать в полной мере аппаратную поддержку вывода трехмерной графики с помощью библиотеки Direct3D версии 9. Необходимо также получать текущий снимок экрана.
###	Требование к численности и квалификации персонала системы

Оператор должен иметь навыки работы в операционной системе Windows 2000/XP/2003 и быть ознакомлен с руководством оператора.

###	Требование к надежности

Программа должна адекватно информировать пользователя об ошибках в его действиях, недопустимых параметрах при вводе. Необходимо предусмотреть выдачу сообщения при невозможности работы программы из-за аппаратной несовместимости.

###	Требования к составу и параметрам технических средств

1)	IBM/PC совместимый компьютер;
2)	Видеокарта GeForce 4 MX и выше;
3)	256 МБ ОЗУ;
4)	SVGA монитор, поддерживающий минимальное разрешение 800 на 600 при глубине цвета в 16 бит;
5)	10 МБ свободного места на НЖМД.

###	Требования к информационной и программной совместимости

Программа должна работать под управлением следующих операционных систем:
1)	Windows 2000 Workstation, Server, Advance Server SP4;
2)	Windows XP Professional SP2;
3)	Windows 2003 Server.

Установленная версия библиотеки DirectX – 9.0с и выше.

###	Требование к программному интерфейсу

САПР должен предоставлять программный интерфейс для внедрения компонента отображения моделей в клиентское приложение СКЗ. Компонент должен быть выполнен в виде динамической загружаемой библиотеки (DLL) и иметь интерфейс сопряжения на языках C/C++ .

####	Экспортируемые функции библиотеки

HRESULT CreateRender( HWND hWnd, IRoomRender** pRoomRender) 
hWnd – дескриптор окна, на одном из которых будет производиться отображение модели.
pRoomRender – указатель на указатель на интерфейс отображения модели.

####	Значения возвращаемой величины
Возвращаемые значения типа HRESULT, если не оговорено дополнительно, берутся из таблицы.
Результат	Описание
S_OK	Операция выполнена успешно
E_NOINTERFACE	Нет такого интерфейса
E_INVALIDARG	Неправильный входной параметр
E_NOTIMPL	Функция не реализована
E_POINTER	Неправильный входной указатель
E_FAIL	Общая ошибка

####	Интерфейс отображения модели IRoomRender

1)	HRESULT Load(const void* pData, size_t nSize)
Загрузка подготовленной модели из RAM в интерфейс.
pData – указатель на начало массива данных.
pRoomRender – размер массива данных в октетах.

2)	HRESULT Render( HWND hWnd, COLORREF clBgColor) 
Отображение загруженной модели в окно.
hWnd – дескриптор окна, в которое отображается модель.
clBgColor – цвет заднего фона.

3)	HRESULT SetImage( int nCamX, int nCamY, const BITMAPINFO* pBmpHdr, const BYTE* pSrcData) 
Загрузка изображения модели из RAM в интерфейс.
nCamX, nCamY – положение камеры, для которой задается изображение.
pBmpHdr – заголовок изображения
pSrcData  – данные изображения

4)	HRESULT Resize( HWND hWnd, DWORD dwWidth, DWORD dwHeight) 
Изменение размеров области отображения модели.
hWnd – дескриптор окна, в которое отображается модель.
dwWidth, dwHeigth – новые размеры области отображения в окне.

5)	HRESULT SetText( const LOGFONTW\* pLogFont, LPCWSTR szText, COLORREF clText)
Вывести в левом верхнем углу сообщение при отображении модели.
pLogFont – параметры шрифта текста.
szText – текст сообщения.
clText  – цвет сообщения.

6)	HRESULT LockFrame(const BITMAPINFO\*& pBmpHdr, const BYTE*& pImg, int& nSize)
Сохранить во внутреннем буфере текущий снимок экрана.
pBmpHdr –заголовок изображения.
pImg – данные изображения.
nSize  – размер данных в октетах.

7)	HRESULT UnlockFrame()
Освободить снимок, сохраненный LockFrame.

8)	std::pair<int,int> GetCamera( const POINT& pt )
Определить, какой камере на модели относиться точка pt. Функция возвращает координаты камеры.
pt – оконные координаты точки.

9)	HRESULT TestComponent()
Тестирование на аппаратную совместимость.

10)	void Release()
Освободить реализацию интерфейса.
